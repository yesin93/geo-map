<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<head>
    <title>CEP Geo Map</title>

    <!-- style files-->
    <link rel="stylesheet" href="css/leaflet.css"/>
    <link rel="stylesheet" href="css/Control.Opacity.css"/>
    <link rel="stylesheet" href="css/jquery-ui-1.10.3.custom.min.css"/>
    <!--<link rel="stylesheet" href="css/font-wso2.css">-->
    <style type="text/css">
        #openStreetMapId {
            height: 95vh;
        }
    </style>

    <!-- script files-->
    <script src="js/leaflet.js"></script>
    <script src="js/Control.Opacity.js"></script>
    <script src="js/jquery-1.9.1.js"></script>
    <script src="js/jquery-ui-1.10.3.custom.min.js"></script>
</head>

<body>
<button id="Register" onclick="addMarker() ">Register Location</button>
<button id="Remove" onclick="removeMarky() ">Remove Location</button>


<div id="openStreetMapId"></div>

<!--scripts-->
<script type="text/javascript">

    //image bounds
    var swLat;
    var swLong;
    var neLat;
    var neLong;
    var baseMap;
    var svgMapUrl;
    var svgMapBounds;
    var svgMapOverlay;

    //marker
    //    var marky;

    //utils
    var isOpacityNotSet = true;
    var deviation = 0.0001;
    var opacitySlider = new L.Control.opacitySlider();

    //on load
    //
    initialiseMap();

    //add base map
    function initialiseMap() {

        //Renders map to user's current location
        baseMap = L.map('openStreetMapId').locate({setView: true, maxZoom: 17});


        //Rendering resources
        L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: 'Map data Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, CC-BY-SA.'
        }).addTo(baseMap);

        //show current location
        baseMap.on('locationfound', showMe);
        function showMe(e){
            popup.setLatLng(e.latlng).setContent("Hi! You're  at " + e.latlng.toString())
                    .openOn(baseMap);
        }

        //On location error
        function onLocationError(e) {
            alert(e.message);
        }

        baseMap.on('locationerror', onLocationError);

        //show coordinates
        var popup = L.popup();

        popup.setLatLng(latlng).setContent("You are here at " + latlng.toString())
                .openOn(baseMap);


        function onMapClick(e) {
            popup
                    .setLatLng(e.latlng)
                    .setContent("You clicked the map at " + e.latlng.toString())
                    .openOn(baseMap);
        }

        baseMap.on('click', onMapClick);
    }


    function addMarker() {

        //Adds a marker to the map on double click
//        baseMap.once('dblclick', onDblClick);
//
//function onDblClick(e) {
//    var daLocation = e.latlng;
//   marky = new L.marker(daLocation
//           ,{draggable:true, riseOnHover: true}).addTo(baseMap)
//            .bindPopup('How many floors does your building have?')
//            .openPopup()
//            .keepInView;
//}
//
//        //load controllers
//        showControlButtons();
//        if (isOpacityNotSet) {
//            baseMap.addControl(opacitySlider);
//            isOpacityNotSet = false;
//        }
//        opacitySlider.setOpacityLayer(marky);
        // attaching function on map click

        //change buttons
        var elem = document.getElementById("Register");
        if (elem.value == "Register Location") elem.value = "Done";
        else elem.value = "Done";

        baseMap.on('dblclick', onMapClick);

// Script for adding marker on map click
        function onMapClick(e) {

            var geojsonFeature = {
                "type": "Feature",
                "properties": {},
                "geometry": {
                    "type": "Point",
                    "coordinates": [e.latlng.lat, e.latlng.lng]
                }
            }

            var marker;

            L.geoJson(geojsonFeature, {

                pointToLayer: function (feature, latlng) {

                    marker = L.marker(e.latlng, {

                        title: "Resource Location",
                        alt: "Resource Location",
                        riseOnHover: true,
                        draggable: true,

                    }).bindPopup("<input type='button' value='Delete this marker' class='marker-delete-button'/>");

                    marker.on("popupopen", onPopupOpen);

                    return marker;
                }
            }).addTo(baseMap);
        }


// Function to handle delete as well as other events on marker popup open
        function onPopupOpen() {

            var tempMarker = this;

            //var tempMarkerGeoJSON = this.toGeoJSON();

            //var lID = tempMarker._leaflet_id; // Getting Leaflet ID of this marker

            // To remove marker on click of delete
            $(".marker-delete-button:visible").click(function () {
                baseMap.removeLayer(tempMarker);
            });
        }

    }

    //remove the markers
    function removeMarky() {
        baseMap.on('dblclick', removeMarker);
        function removeMarker(e) {
            var daLocation = e.latlng;
            baseMap.removeLayer();
        }
    }


    //remove svg map
    //    function removeMarker(){
    //        //remove layer
    ////        baseMap.removeLayer(svgMapOverlay);
    //        document.getElementById("Register").value == "Register Location";
    //        hideControlButtons();
    ////        clearValuesInTextBox();
    //        opacitySlider.removeFrom(baseMap);
    //        isOpacityNotSet = true;
    //
    //    }


</script>

</body>
</html>