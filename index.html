<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>WSO2 Stream Processor</title>
    <link href="libs/theme-wso2_2.0.0/images/favicon.png" rel="icon" type="image/png" sizes="16x16"/>
    <!-- WSO2 Theme -->
    <link href="libs/theme-wso2_2.0.0/css/theme-wso2.css" rel="stylesheet" type="text/css"/>

    <!-- Font WSO2 CSS -->
    <link href="libs/font-wso2_1.1.1/css/font-wso2.min.css" rel="stylesheet" type="text/css"/>

    <!--fontawesome-->
    <link href="libs/font-awesome_4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <!--leaflet-->
    <link rel="stylesheet" href="css/leaflet.css"/>
    <link rel="stylesheet" href="css/leaflet-sidebar.min.css"/>

    <link href="libs/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet" type="text/css"/>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body class="sticky-footer fixed">

<!-- header -->
<header class="header header-default">
    <div class="container-fluid">
        <div class="pull-left brand">
            <a href="#">
                <img src="libs/theme-wso2_2.0.0/images/logo-inverse.svg" alt="wso2" title="wso2" class="logo">
                <span>IoT Server Floorplan Visualizer</span>
            </a>
        </div>
    </div>
</header>
<!-- /header -->

<!-- navbar -->
<div class="navbar-wrapper">
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <div class="navbar-brand">
                    <a href="#">Geographic View</a>
                </div>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="#" onclick="onAddMarker()">
                                <span class="icon fw-stack">
                                    <i class="fw fw-add fw-helper fw-helper-circle-outline"></i>
                                </span>
                            Add Building
                        </a>
                    </li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>
</div>
<!-- /navbar -->


<div class="page-content-wrapper">

    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-building"></i></a></li>
                <!--<li><a href="#info" role="tab"><i class="fa fa-info-circle"></i></a></li>-->
                <li class="disabled"><a href="#messages" role="tab"><i class="fa fa-envelope"></i></a></li>
            </ul>

        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                    Buildings
                    <span class="sidebar-close"><i class="fa fa-caret-right"></i></span>
                </h1>
            </div>
            <div class="sidebar-pane" id="messages">
                <h1 class="sidebar-header">Messages<span class="sidebar-close"><i class="fa fa-caret-right"></i></span>
                </h1>
            </div>
        </div>
    </div>

    <div id="openStreetMapId" style="height:100%"></div>

</div>

<footer class="footer">
    <div class="container-fluid">
        <p>WSO2 <span class="hidden-xs">IoT Server Floorplan Visualizer</span> | &copy;
            <script>document.write(new Date().getFullYear());</script>
            <a href="http://wso2.com/" target="_blank"><i class="icon fw fw-wso2"></i> Inc</a>.
        </p>
    </div>
</footer>

<!-- jQuery (necessary for Bootstrap and WSO2 Theme JavaScript plugins) -->
<script src="libs/jquery_1.11.0/jquery-1.11.3.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="libs/bootstrap_3.3.6/js/bootstrap.min.js"></script>
<script src="libs/theme-wso2_2.0.0/js/theme-wso2.min.js"></script>

<!--sidebar js-->
<script src="js/leaflet.js"></script>
<script src="js/leaflet-sidebar.min.js"></script>
<script src="js/jquery-sidebar.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.15.1/jquery.validate.min.js"></script>

<!--scripts-->
<script type="text/javascript">

    //image bounds
    var baseMap;

    //Array to store marker latlng and ID
    var markers = [];

    // quick and dirty: create a big icon
    L.Icon.Big = L.Icon.Default.extend({
        options: {
            iconSize: new L.Point(30, 49),
        }
    });

//    //custom icon
//    var buildingIcon = L.icon({
//        iconUrl: 'building-marker.png',
//        shadowUrl: 'marker-shadow.png',
//
//        iconSize:     [30, 90], // size of the icon
//        shadowSize:   [50, 64], // size of the shadow
////        iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
////        shadowAnchor: [4, 62],  // the same for the shadow
//        popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
//    });

    //THE ICONS
    var bigIcon = new L.Icon.Big();
    var smallIcon = new L.Icon.Default();


    //on load
    initialiseMap();

    //add base map
    function initialiseMap() {

        //Renders map to user's current location
        baseMap = L.map('openStreetMapId').locate({setView: true, maxZoom: 17, animate: true, duration: 3});

        var sidebar = L.control.sidebar('sidebar', {position: 'right'}).addTo(baseMap);

        //Rendering resources
        L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: 'Map data Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, CC-BY-SA.'
        }).addTo(baseMap);

        //show current location
        baseMap.on('locationfound', showMe);
        function showMe(e) {
            popup.setLatLng(e.latlng).setContent("Hi! You're Here")
                    .openOn(baseMap)
                    .keepInView;
        }

        //On location error
        function onLocationError(e) {
            alert(e.message);
        }

        baseMap.on('locationerror', onLocationError);

        var popup = L.popup();

    }

    //    reading data from JSON
    $(document).ready(function () {
        $.get('result.json', function (data) {
            $.each(data.metaData, function(i, n){
                addingMarker(null, n);
            });
        });
    });

    function openWin(id) {
        window.open("visualizer.html?id=" + id);
    }

    // Script for adding marker
    function addingMarker(e, d) {

        var cord,
            locationName,
            address,
            floorCount,
            markerId,
            popup;

        if(e !== null){
            cord = e.latlng;
            locationName = "";
            address = "";
            floorCount = "";

            popup = L.popup({
                autoPan: true,
                keepInView: true})
                .setContent('<p>Hello there!<br />Please enter the marker details! :)</p>');
        }
        else {
            cord = L.latLng(d.coordinates.lat, d.coordinates.lng);
            locationName = d.locationName;
            address = d.address;
            floorCount = d.floors;
            markerId = d.id;
//            markers._leaflet_id = markerId;

            //popup content
            var popupContent = '<h4>'+ locationName +'</h4>' +
                '<ul>' +
                    '<li>No of Floors: '+ floorCount+' </li>' +
                    '<li> Address: '+ address+'</li>' +
                '</ul>';

            popup = L.popup({
                autoPan: true,
                keepInView: true})
                .setContent(popupContent);
        }

        //variable for marker
        var marker;

        //markers info JSON array
        var markerInfo = {
            info: []
        };

        marker = new L.marker(cord, {
            title: "Resource Location",
            alt: "Resource Location",
            riseOnHover: true,
            draggable: true
        }).bindPopup(popup);

        marker._leaflet_id = markerId;


        marker.on('click', onMarkerClick);
        marker.on("popupopen", onPopupOpen);
        marker.addTo(baseMap);

        if(e !== null){
            markerId = marker._leaflet_id;
            console.log(marker._leaflet_id);
        }

        markers[markerId] = marker;
        console.log(markerId);
        console.log(markers[markerId]);

        //append the information to the sidebar
        $('#home').append(
        <!-- collapse -->
                '<div class="item panel-group add-margin-bottom-2x" role="tablist" aria-multiselectable="false" id="' + markerId + '" data-lat="' + marker._latlng.lat + '" data-lng="' + marker._latlng.lng + '" >' +
                //'<div class="" role="tablist" aria-multiselectable="false">'+
                    '<div class="panel panel-default">'+
                        '<div class="panel-heading" role="tab" id="heading' + markerId + '" data-toggle="collapse" href="#accordion' + markerId + '" aria-controls="accordion' + markerId + '">'+
                                '<h4 class="panel-title">New Building</h4>'+
                                '<div class="btn-group">' +
                                    '<button type="button" class="btn btn-primary add-margin-right-2x" data-toggle="edit-floors">' +
                                        '<span class="icon fw-stack add-margin-right-1x">'+
                                            '<i class="fw fw-edit  fw-helper fw-helper-circle-outline"></i>' +
                                        '</span>Edit Floors' +
                                    '</button>'+
                                    '<button type="button" class="btn btn-secondary remove add-margin-right-2x" data-toggle="" id="' + markerId + '">' +
                                        '<span class="icon fw-stack add-margin-right-1x">'+
                                            '<i class="fw fw-delete  fw-helper fw-helper-circle-outline"></i>' +
                                        '</span>' +
                                    'Delete Building</button>' +
                                   '<div class="clearfix"></div>'+
                                '</div>' +
//                            '<a href="#" class="remove" id="' + markerId + '">' +
//                                '<span class="icon fw-stack">' +
//                                '<i class="fw fw-delete fw-stack-1x"></i>' +
//                                '</span> Remove' +
//                            '</a>' +
//                            '<button type="button" class="btn btn-secondary" data-toggle="edit-floors">Edit Floors</button>' +

                '</div>'+
                '<div id="accordion' + markerId + '" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading' + markerId + '">'+
                    '<div class="panel-body">'+
                        '<form action="" method="post" id="register-form-'+ markerId +'" novalidate="novalidate">' +
                            '<div class="form-group">' +
                                '<label for="locationName">Location Name *</label>' +
                                '<input type="text" class="form-control" name="locationName" placeholder="e.g.: Home" value="' + locationName + '">' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label for="address">Address *</label>' +
                                '<input type="text" class="form-control" name="address" placeholder="e.g.: 13/13, Mockingbird Ave, New York" value="'+address+'">' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label for="floors">No. of Floors *</label>' +
                                '<input type="number" class="form-control required" name="floors" placeholder="e.g.: Number of floors" value="'+floorCount+'">' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<button type="button" class="btn btn-primary" data-toggle="update-data">Save</button>' +
//                                '<button type="button" class="btn btn-secondary" data-toggle="edit-floors">Edit Floors</button>' +
                            '</div>' +
                        '</form>' +
                    '</div>'+
                '</div>'+
            '</div>'+
//       '</div>'+
                '</div>');
       <!-- /collapse -->

        //Adding panel heading on load only
        if(e == null){
            $('#heading'+markerId).find('.panel-title').text(locationName);
        }


        // Remove Marker
        $('.remove').on("click", function () {
            // Remove the marker
            baseMap.removeLayer(markers[$(this).attr('id')]);

            var idNo = $(this).attr('id');
            // Remove the link
            $(this).parent('div').remove();

            $('#home').find('#' + idNo).remove();
        });

        /*
        Pan to Marker on item panel hover
         */
        $('.item').on("mouseover", function (e) {
            $('div').removeClass('active-marker');
            $(this).addClass('active-marker');
            for (var mark in markers) {
                markers[mark].setIcon(smallIcon);
            }
            markerFunction($(this).attr('id'));
            markers[$(this).attr('id')].setIcon(bigIcon);
            var mid = $(this).attr('id');
            var LatLng = markers[mid].getLatLng();
            var offset = baseMap.panTo(LatLng);
            baseMap.panBy(offset);
        });
    }

    //open marker popup
    function markerFunction(id) {
//        console.log(markers[id]);
        markers[id].openPopup();

    }

    $('#home').on('click', '[data-toggle=edit-floors]', function(e){
        if($(e.target).closest('.panel-heading').next('.panel-collapse').find('form').valid()) {
            var markerID = $(e.target).closest('.item').prop('id');
            openWin(markerID);
        }
    });

    $('.leaflet-popup').on('click', '[data-toggle=edit-floors]', function(e){
        console.log(e.target);
   if($(e.target).closest('.panel-heading').next('.panel-collapse').find('form').valid()) {
        var markerID = $(e.target).closest('.item').prop('id');
        openWin(markerID);
        }
    });



    // Function to handle delete as well as other events on marker popup open
    function onPopupOpen() {
        var tempMarker = this;
    }

    //Set
    function onMarkerClick(e) {
        $('div').removeClass('active-marker');
        $('div #' + e.target._leaflet_id).addClass('active-marker');
        for (var mark in markers) {
            markers[mark].setIcon(smallIcon);
        }
        var offset = baseMap.panTo(markers[mark].getLatLng());
        baseMap.panBy(offset);
    }

    function onAddMarker() {
        baseMap.once('click', addingMarker);
    }


</script>

<script src="js/createJSON.js"></script>


</body>
</html>